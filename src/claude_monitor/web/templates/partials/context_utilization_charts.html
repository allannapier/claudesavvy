<!-- Context Utilization Trend Chart -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mt-8">
    <div class="flex justify-between items-center mb-4">
        <div>
            <h3 class="text-lg font-semibold text-gray-900">Request Token Utilization Over Time</h3>
            <p class="text-sm text-gray-500 mt-1">
                Percentage of context window used by request/response tokens only.
                <span class="text-amber-600">Note: This excludes system prompts, tool definitions, and conversation overhead.</span>
            </p>
        </div>
        <div class="flex items-center gap-4 text-sm">
            <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-green-500"></span>
                <span class="text-gray-600">&lt;50%</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-yellow-500"></span>
                <span class="text-gray-600">50-80%</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-red-500"></span>
                <span class="text-gray-600">&gt;80%</span>
            </div>
        </div>
    </div>
    <div class="px-4 py-3 bg-amber-50 border border-amber-200 rounded-lg mb-4">
        <div class="flex items-start gap-2">
            <svg class="w-5 h-5 text-amber-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <p class="text-sm text-amber-700">
                <strong>Limited visibility:</strong> This chart shows only the tokens counted in API responses (input + output). Actual context usage is typically 2-10x higher due to system prompts, tools, agents, and conversation history.
            </p>
        </div>
    </div>
    <div style="height: 300px;">
        <canvas id="contextUtilizationChart"></canvas>
    </div>
</div>

<script>
(function() {
    // Destroy existing chart if it exists (for HTMX reloads)
    const existingChart = Chart.getChart('contextUtilizationChart');
    if (existingChart) existingChart.destroy();

    // Use requestAnimationFrame to wait for DOM layout before creating chart
    requestAnimationFrame(function() {
        requestAnimationFrame(function() {
            initContextUtilizationChart();
        });
    });

    function initContextUtilizationChart() {
        const ctx = document.getElementById('contextUtilizationChart');
        if (ctx) {
            const labels = {{ context_util_trend.labels|default([])|tojson }};
            const datasets = {{ context_util_trend.datasets|default([])|tojson }};

            // Only create chart if we have data
            if (labels && labels.length > 0 && datasets && datasets.length > 0) {
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets.map(ds => ({
                            label: ds.label,
                            data: ds.data,
                            borderColor: ds.borderColor,
                            backgroundColor: 'transparent',
                            tension: 0.4,
                            fill: false,
                            borderWidth: 2,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        }))
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'bottom',
                                labels: {
                                    padding: 12,
                                    usePointStyle: true,
                                    font: {
                                        size: 11
                                    }
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        let value = context.parsed.y;
                                        if (value > 0) {
                                            label += value.toFixed(1) + '%';
                                        }
                                        return label;
                                    }
                                }
                            },
                            annotation: {
                                annotations: {
                                    line80: {
                                        type: 'line',
                                        yMin: 80,
                                        yMax: 80,
                                        borderColor: 'rgb(239, 68, 68)',
                                        borderWidth: 2,
                                        borderDash: [5, 5],
                                        label: {
                                            display: true,
                                            content: 'High (80%)',
                                            position: 'end',
                                            backgroundColor: 'rgba(239, 68, 68, 0.8)',
                                            font: {
                                                size: 10
                                            }
                                        }
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            } else {
                // Show empty state
                ctx.parentElement.innerHTML = `
                    <div class="flex items-center justify-center h-full text-gray-500">
                        <div class="text-center">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            <p class="mt-2">No context utilization data available</p>
                        </div>
                    </div>
                `;
            }
        }
    }
})();
</script>
